# ============================================================
# Global project paths and settings
# ============================================================

# Update these directory names for the different commmands to write data and results
# for each mode to separate folders.
# Otherwise, results may be overwritten when running different modes.
# Example, for running let's say kinopt in local mode:
# Command - python phoskintime kinopt --mode local
# Directories can be named accordingly, e.g., results_kinopt_local
# Updating both, results_dir and logs_dir is recommended.

[paths]
data_dir      = "data"
results_dir   = "results_model"
logs_dir      = "results_model/logs"
ode_data_dir  = "data"


# ============================================================
# TF OPTIMIZATION (mRNA → TF)
# Used by:
#   - tfopt.local.config.constants
#   - tfopt.evol.config.constants
# ============================================================

[tfopt]

# --------------------
# Input files
# --------------------
input1 = "input1.csv"     # expression / mRNA
input3 = "input3.csv"     # TF activity / Rout-Limma
input4 = "input4.csv"     # TF metadata / network

# --------------------
# Output
# --------------------
out_file = "tfopt_results.xlsx"

# --------------------
# Time grid (minutes)
# --------------------
time_points = [
  4, 8, 15, 30, 60,
  120, 240, 480, 960
]

# --------------------
# Default optimization parameters
# (used unless overridden by CLI or mode)
# --------------------
lower_bound = -4.0
upper_bound =  4.0

# Loss types (integer, matches tfopt code)
# 0: MSE
# 1: MAE
# 2: soft L1
# 3: Cauchy
# 4: Arctan
# 5: Elastic Net
# 6: Tikhonov
loss_type = 5

# --------------------
# Mode-specific overrides
# --------------------

[tfopt.modes.local]
# SLSQP / TRUST-CONSTR defaults
# (keep wide bounds for local refinement)
lower_bound = -4.0
upper_bound =  4.0
loss_type   = 5

[tfopt.modes.evol]
# Global evolutionary search defaults
lower_bound = -4.0
upper_bound =  4.0
loss_type   = 5

# Optimizer choices:
# 0: NSGA-II
# 1: SMSEMOA
# 2: AGEMOEA
optimizer = 0


# ============================================================
# KINASE OPTIMIZATION (Kinase → Phosphosite)
# Used by:
#   - kinopt.local.config.constants
#   - kinopt.evol.config.constants
# ============================================================

[kinopt]

# --------------------
# Input files (relative to data_dir)
# --------------------
input1 = "input1.csv"   # kinase / protein abundance
input2 = "input2.csv"   # phosphosite data

# --------------------
# Output
# --------------------
out_file = "kinopt_results.xlsx"

# --------------------
# Time grid (minutes)
# --------------------
time_points = [
  0.0, 0.5, 0.75, 1.0,
  2.0, 4.0, 8.0, 16.0,
  30.0, 60.0, 120.0,
  240.0, 480.0, 960.0
]

# --------------------
# Default optimization parameters
# --------------------
lower_bound = -4.0
upper_bound =  4.0

# Loss types (string, matches kinopt code)
# base | weighted | softl1 | cauchy | arctan
loss_type = "weighted"

# Estimate missing kinase–psite pairs?
estimate_missing_kinases = true

# Scaling options:
# min_max | log | temporal | segmented | slope | cumulative | none
scaling_method = "none"

# Used for temporal scaling
split_point = 9

# Used for segmented scaling
segment_points = [0, 3, 6, 9, 14]

# Optimization method (local)
# slsqp | trust-constr
method = "slsqp"


# --------------------
# Mode-specific overrides
# --------------------

[kinopt.modes.local]
# Trust the defaults; override if needed
method = "slsqp"

[kinopt.modes.evol]
# Narrower bounds for global search
lower_bound = -4.0
upper_bound =  4.0

# Loss choices for evol
# base | autocorrelation | huber | mape | weighted
loss_type = "base"

# Regularization (used only in evol)
regularization = false

# Evolutionary optimizer backend
# DE | NSGA-II (string)
method = "NSGA-II"

# ============================================================
# ODE PIPELINE (downstream of kinopt + tfopt)
# Used by:
#   - config.constants
# ============================================================

[ode]

# Which ODE model
# distmod | succmod | randmod

# After setting the results_dir and logs_dir globally above,
# you can set the model type here to have separate output folders
# for each model type.
model = "randmod"

# Upper bounds used in parameter fitting / priors
[ode.bounds]
mRNA_prod    = 20
mRNA_deg     = 20
protein_prod = 20
protein_deg  = 20
phospho_prod = 20
phospho_deg  = 20

# Bootstrap settings
[ode.bootstrap]
n = 0

# Time grids (minutes)
[ode.time]
protein = [0.0, 0.5, 0.75, 1.0, 2.0, 4.0, 8.0, 16.0, 30.0, 60.0, 120.0, 240.0, 480.0, 960.0]
rna     = [4.0, 8.0, 15.0, 30.0, 60.0, 120.0, 240.0, 480.0, 960.0]

# Fit controls
[ode.fit]
normalize_model_output = false
use_custom_weights     = false
use_regularization     = true

[ode.fit.composite_weights]
rmse = 1.0
mae  = 1.0
var  = 1.0
mse  = 1.0
l2   = 1.0

# Sensitivity
[ode.sensitivity]
enabled      = true
perturbation = 0.5

[ode.sensitivity.morris]
num_trajectories = 1000
num_levels       = 400

# Plot
[ode.plot]
perturb_trace_opacity = 0.02

# Inputs to the ODE pipeline.
# Make these explicit and stable (no importing from other modules).
[ode.inputs]
# These are paths relative to PROJECT ROOT. You can also make them relative to data_dir if you prefer.
protein_excel = "data/input1.csv"
psite_excel   = "data/kinopt_results.xlsx"
rna_excel     = "data/tfopt_results.xlsx"

# Output naming (optional)
[ode.output]
out_dir_name = ""   # if empty, code can use "<ModelType>_results"
out_xlsx_name = ""  # if empty, code can use "<ModelType>_results.xlsx"

# ============================================================
# GLOBAL MODEL (Integrated ODE Optimization)
# Used by: global_model.runner
# ============================================================

[global_model]
app_name = "Phoskintime-Global"
version = "0.1.0"

# ------------------------------------------------------------
# INPUT FILES (Required by runner)
# Paths are relative to the project root
# ------------------------------------------------------------
kinase_net = "data/input2.csv"         # Kinase-Substrate Network (or similar)
tf_net     = "data/input4.csv"         # TF-Gene Network
ms         = "data/input1.csv"         # Mass Spec (Protein) Data
rna        = "data/input3.csv"         # RNA (Transcriptomics) Data
phospho    = "data/input1.csv"         # Phospho Data (Optional, can be same as ms if mixed)

# Previous optimization results (Priors)
kinopt     = "data/kinopt_results.xlsx"
tfopt      = "data/tfopt_results.xlsx"

# ------------------------------------------------------------
# RUN SETTINGS
# ------------------------------------------------------------
output_dir = "results_test2"  # Output directory
cores      = 8                         # 0 or leave out to use all available cores
seed       = 42

# ------------------------------------------------------------
# OPTIMIZATION PARAMETERS (Pymoo)
# ------------------------------------------------------------
n_gen      = 1000                       # Generations (runner arg: --n-gen)
pop        = 300                       # Population size (runner arg: --pop)
refine     = true                     # Run 2nd pass with tighter bounds (runner arg: --refine)
num_refinements = 0                       # Number of refinements
loss = 4                        # Loss type (0: MSE, 1:Huber, 2:Psuedo-Huber, 4:Charbonnier)

# ------------------------------------------------------------
# LOSS WEIGHTS (Regularization)
# ------------------------------------------------------------
lambda_prior   = 0.1                  # Weight for prior adherence (runner arg: --lambda-prior)
lambda_protein = 1.0                   # Weight for protein error (runner arg: --lambda-protein)
lambda_rna     = 0.2                   # Weight for RNA error (runner arg: --lambda-rna)
lambda_phospho = 3.0                   # Weight for Phospho error (runner arg: --lambda-phospho)

# ------------------------------------------------------------
# DATA INFERENCE FLAGS
# ------------------------------------------------------------
normalize_fc_steady = false             # Normalize data to t=0 (runner arg: --normalize-fc-steady)
use_initial_condition_from_data = true  # Use data for t=0 state (runner arg: --use-initial-condition-from-data)

# ------------------------------------------------------------
# MODEL & BOUNDS CONFIGURATION
# ------------------------------------------------------------

[global_model.timepoints]
protein = [0.0, 0.5, 0.75, 1.0, 2.0, 4.0, 8.0, 16.0, 30.0, 60.0, 120.0, 240.0, 480.0, 960.0]
phospho_protein = [0.0, 0.5, 0.75, 1.0, 2.0, 4.0, 8.0, 16.0, 30.0, 60.0, 120.0, 240.0, 480.0, 960.0]
rna = [4.0, 8.0, 15.0, 30.0, 60.0, 120.0, 240.0, 480.0, 960.0]

[global_model.bounds]
# Kinase Activity Multiplier: Keep as is, 4.0 is a reasonable max fold-change
c_k = [1e-3, 4.0]

# Basal mRNA Transcription: Keep wide to allow for low-abundance genes
A_i = [1e-6, 10.0]

# mRNA Degradation: 0.1 is ~7min half-life, 0.001 is ~11 hours.
B_i = [1e-3, 1.0]

# Translation Rate (The "Balloon" Variable):
# Lower the max significantly. Proteins rarely translate at 100x basal speed.
C_i = [1e-3, 2.0]

# Protein Deactivation (State reset):
# Increase the floor. 1e-6 is essentially "never turns off."
D_i = [0.1, 0.5]

# Phospho-site Dephosphorylation:
# Usually faster than total protein deactivation.
Dp_i = [0.05, 5.0]

# Transcriptional Efficacy (Alpha):
# 10.0 is a strong regulator.
E_i = [1e-4, 10.0]

# TF Scaling (The "Sensitivity" exponent):
# If using Exponential coupling, +/- 4.0 is very high (e^4 = 54x).
# +/- 2.0 (e^2 = 7x) is often more stable for global models.
tf_scale = [2.0, 10.0]

[global_model.models]
available_models = ["distributive", "sequential", "combinatorial"]
default_model = "distributive"

[global_model.solver]
absolute_tolerance = 1e-8
relative_tolerance = 1e-8
max_timesteps = 200000
use_custom_solver = true